<html>
<head>
    <meta http-equiv="Content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=100%, initial-scale=1, minimum-scale=1, maximum-scale=1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title id="oti"></title>
    <link rel="stylesheet" href="__CSS__/style.css?v=7">
    <link rel="stylesheet" href="__CSS__/shop.css?v=2">
    <link rel="stylesheet" href="__CSS__/icon/iconfont.css">
    <link rel="stylesheet" href="__CSS__/iphone.css">
    <link rel="stylesheet" href="__CSS__/swiper.min.css">
</head>
<body>

<div id="main">
    <div class="header-bar select-shopbar" style="position:fixed;">
        <div class="header-title" style="display:inline-block;width:100%;">选择店铺</div>
        <span id="pi_back" style="display:none" onclick="history.go(-1)"></span>
    </div>

    <div class="pi_sousuo1" style="">
        <input class="pi_input" placeholder="请输入店铺名称" style="">
        <span class="pi_sousuo" style=""></span>
        <span class="pi_sousuo2" style="" onclick="searchShop();">搜索</span>
    </div>
    <div style="padding:5px 14px;background-color: #f5f5f5;">
        <i class="iconfont" style="color:A9A9A9;">&#xe600;</i>
        <span id="pi_address" style=""></span>
    </div>

    <div class="shop-list" id="mod-desc">


    </div>
</div>
<div id="page_tag_load"><img src="__IMG__/ajax-loader.gif" alt="loader"></div>

<script>
    var data = {
        'wxConfig': {$wxConfig? $wxConfig : '[]'},
        'config': {$config? $config : '[]'},
        'user': {$user? $user : '[]'},
        'ads': {$ads? $ads : '[]'},
        'menu': {$menu? $menu : '[]'},
        'product': {$product? $product : '[]'},
        'baseUrl': '__APP__',
        'uploadsUrl': '__PUBLIC__/Uploads/',
        'imageUrl': '__IMG__',
        'shopId': '',
    }
    console.log(data);
</script>
<script src="__JS__/jquery.min.js"></script>
<script src="__JS__/path.min.js"></script>
<script src="__JS__/jquery.cookie.js"></script>
<script src="__JS__/swiper.min.js"></script>
<script src="__JS__/jweixin-1.0.0.js"></script>
<script src="__TPL_PUBLIC__/build/template.js"></script>
<script src="__JS__/echo.min.js"></script>
<script src="__JS__/layer.m.js"></script>
<script src="__JS__/wemall.js?v=7"></script>

<script>
    $('#page_tag_load').show();
    wx.config({
        debug: false, // 开启调试模式,调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。
        appId: data.wxConfig.appId, // 必填，公众号的唯一标识
        timestamp: data.wxConfig.timestamp, // 必填，生成签名的时间戳
        nonceStr: data.wxConfig.nonceStr, // 必填，生成签名的随机串
        signature: data.wxConfig.signature,// 必填，签名，见附录1
        jsApiList: ['getLocation'] // 必填，需要使用的JS接口列表，所有JS接口列表见附录2
    });
    wx.ready(function () {
        wx.getLocation({
            type: 'wgs84', // 默认为wgs84的gps坐标，如果要返回直接给openLocation用的火星坐标，可传入'gcj02'
            success: function (res) {
                lat = res.latitude; // 纬度，浮点数，范围为90 ~ -90
                lng = res.longitude; // 经度，浮点数，范围为180 ~ -180。
                var speed = res.speed; // 速度，以米/每秒计
                var accuracy = res.accuracy; // 位置精度
                locationmy(lat, lng);
                shopList(lat, lng);
            }
        });
    })
    function locationmy(lat, lng) {
        // lng = 113.650035;//用户经度
        // lat = 34.7854;//用户纬度
        var script = document.createElement('script');
        script.type = 'text/javascript';
        script.src = 'http://restapi.amap.com/v3/geocode/regeo?output=json&location=' + lng + ',' + lat + '&key=22f9022b217b7d764f5befb4aa74456f&radius=1000&extensions=all&callback=renderOption';
        document.head.appendChild(script);
    }
    function renderOption(response) {
        document.getElementById('pi_address').innerHTML = response.regeocode.formatted_address;
    }
    function shopList() {
        $.ajax({
            type: "post",
            url: data.baseUrl + "/App/User/getShopList",
            data: {
                lng: lng,
                lat: lat,
            },
            success: function (res) {
                var html = '';
                $.each(res, function (index, value) {
                    html += '<a class="grst-block" onclick="openTHisShop(' + value.id + ')"><img class="grst-logo" style="opacity: 1; transition: opacity 0.5s;" alt="' + value.name + '" src="' + data.uploadsUrl + value.savepath + value.savename + '"><div class="grst-detail"><div class="grst-name"><span class="ng-binding">' + value.name + '</span><span class="grst-misc ng-binding">&nbsp;&nbsp;' + value.km + 'km</span></div><span class="grst-misc ng-binding">' + value.subname + '</span><div class="grst-misc"><span class="ng-binding">' + value.address + '</span></div><div class="grst-activity "><p class="grst-activity-detail "><span class="rst-badge ng-binding" style="background: rgb(240, 115, 115);">减</span> <span class="ng-binding">满减优惠</span><span class="activity-offline"> (满' + value.full + '减' + value.discount + ')</span></p><p class="grst-activity-detail "><span class="rst-badge ng-binding" style="background: rgb(255, 78, 0);">付</span> <span class="ng-binding">在线支付</span></p></div></div></a>';
                });

                $('#mod-desc').html(html);
            },
            beforeSend: function () {
                // $('#page_tag_load').show();
            },
            complete: function () {
                $('#page_tag_load').hide();
            }

        });
    }
    //pidong 搜索店铺
    function searchShop() {
        var name = $('.pi_input').val();
        $.ajax({
            type: "post",
            url: data.baseUrl + "/App/User/getShopList",
            data: {
                name: name,
                lng: lng,
                lat: lat,
            },
            success: function (res) {
                var html = '';
                $.each(res, function (index, value) {
                    html += '<a class="grst-block" onclick="openTHisShop(' + value.id + ')"><img class="grst-logo" style="opacity: 1; transition: opacity 0.5s;" alt="' + value.name + '" src="' + data.uploadsUrl + value.savepath + value.savename + '"><div class="grst-detail"><div class="grst-name"><span class="ng-binding">' + value.name + '</span><span class="grst-misc ng-binding">&nbsp;&nbsp;' + value.km + 'km</span></div><span class="grst-misc ng-binding">' + value.subname + '</span><div class="grst-misc"><span class="ng-binding">' + value.address + '</span></div><div class="grst-activity "><p class="grst-activity-detail "><span class="rst-badge ng-binding" style="background: rgb(240, 115, 115);">减</span> <span class="ng-binding">满减优惠</span><span class="activity-offline"> (满' + value.full + '减' + value.discount + ')</span></p><p class="grst-activity-detail "><span class="rst-badge ng-binding" style="background: rgb(255, 78, 0);">付</span> <span class="ng-binding">在线支付</span></p></div></div></a>';
                });

                $('#mod-desc').html(html);
            },
            beforeSend: function () {
                $('#page_tag_load').show();
            },
            complete: function () {
                $('#page_tag_load').hide();
            }

        });
    }
</script>
</body>
</html>